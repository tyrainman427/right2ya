{% extends 'base.html' %}

{% block content %}
<div class="container">
  <h1>Create Scheduled Job</h1>
  <form method="POST" id="create-job-form">
    {% csrf_token %}
    <div class="form-group">
      <label for="pickup-address">Pickup Address</label>
      <input type="text" class="form-control" id="pickup-address" name="pickup_address" required>
    </div>

    <div class="form-group">
      <label for="delivery-address">Delivery Address</label>
      <input type="text" class="form-control" id="delivery-address" name="delivery_address" required>
    </div>

    <div class="form-group">
      <label for="date">Date</label>
      <input type="date" class="form-control" id="date" name="date" required>
    </div>

    <div class="form-group">
      <label for="time">Time</label>
      <input type="time" class="form-control" id="time" name="time" required>
    </div>

    <button type="submit" class="btn btn-primary">Create Job</button>
  </form>
</div>

<script>
  function initAutocomplete() {
    var pickupAddressInput = document.getElementById('pickup-address');
    var pickupAddressAutocomplete = new google.maps.places.Autocomplete(pickupAddressInput);

    var deliveryAddressInput = document.getElementById('delivery-address');
    var deliveryAddressAutocomplete = new google.maps.places.Autocomplete(deliveryAddressInput);
  }

  // Load the Google Maps API asynchronously
  function loadScript() {
    var script = document.createElement('script');
    script.src = 'https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAP_API_KEY }}&libraries=places&callback=initAutocomplete';
    script.defer = true;
    document.body.appendChild(script);
  }

  // Call the loadScript function to load the Google Maps API
  loadScript();

  // Submit form to create job
  document.getElementById('create-job-form').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevent form submission
    createJob(); // Custom function to handle job creation
  });

  // Function to create job and redirect to Stripe payment page
  function createJob() {
    var pickupAddress = document.getElementById('pickup-address').value;
    var deliveryAddress = document.getElementById('delivery-address').value;
    var date = document.getElementById('date').value;
    var time = document.getElementById('time').value;

    // Make an AJAX request to your Django view
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'customer/create_job/', true);
    xhr.setRequestHeader('Content-Type', 'application/json');

    xhr.onreadystatechange = function() {
      if (xhr.readyState === XMLHttpRequest.DONE) {
        if (xhr.status === 200) {
          var response = JSON.parse(xhr.responseText);
          var jobId = response.job_id;

          // Redirect to Stripe payment page with the created job ID
          window.location.href = '/stripe_payment/?job_id=' + jobId;
        } else {
          // Handle error case
          console.error('Job creation failed.');
        }
      }
    };

    var data = JSON.stringify({
      pickup_address: pickupAddress,
      delivery_address: deliveryAddress,
      date: date,
      time: time
    });

    xhr.send(data);
  }
</script>
{% endblock %}

